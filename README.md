# Node-Redis обработка сообщений

Модули:
* lib/generator - генерация строк с случайным содержимым
* repository/* - работа с redis, registry - компонент для регистрации нод и существуещего генератора
* node - логика приложения

Реализация:
(r:... - значение в Redis)
1. При каждом запуске создается экземпляр Node, который увеличивает значение
счетчика r:nodeCount (инициализируется с 1), получает имя node:number,
добавляет его в nodeList, и запускает alive-поле
2. Изначально экземпляр Node запускается в режиме Handler(обработчик) и резервирует в Redis
очередь обработки queue:number
3. Для отслеживания состояния экземпляр Node должен перезаписывать свое alive-поле (r:node:number) значением 1 с временем
истечения в 1 секунду
4. Каждый экземпляр Node проверяет с определенным интервалом значение специального alive-поля генератора (r:nodeGenerator),
организованного по принципу alive-поля Node, и, если оно пусто, генератором становится первый экземпляр из nodeList, однако,
перед этим проводится проверка состояния всех Node в nodeList во избежание ситуации назначения отключившейся Node в качестве
генератора (комментарии по таковой возможности читать в node/node.js | function checkGenerator), первый генератор определяет сам себя по такому же принципу, на базе подобных проверок осуществляется динамическая миграция Generator.
5. Генератор Node помимо генерации сообщений осуществляет регулярную проверку nodeList на предмет отключившихся Node (проверяет состояние alive-полей перечисленных в nodeList Node)
6. Генератор записывает генерируемые им значения (применяя модуль generator) в r:messageQueue при помощи rpush с интервалом,
указанным в конструкторе Node
7. Обработчики при помощи rpoplpush добавляют сообщения из messageQueue в свои очереди, и обрабатывают их, допуска с вероятностью в пять процентов ошибочность сообщения (если сообщение ошибочно - то оно записывается в r:errorMessages)

При запуске без параметров создается новый экземпляр Node, при запуске с параметром getErrors выводит массив ошибок, удаляет их из Redis и завершается

Тестировалось с до 10 экземплярами node, с отключением по ctrl-c произвольных экземпляров, включая генератор, при
интенсивности генерации сообщений в 1 мс и вызова обработчиков в каждые 5 мс на протяжении около 35 минут, максимальная очередь сообщений составляла 250000 сообщений, максимальное количество ошибочных сообщений составляло 97000 (что свидетельствует о порядка 1940000 обработанных сообщений), динамическое переназначение генератора и удаление отключившихся Node происходило в штатном режиме, при этом наибольшую нагрузку создавал redis-server (13% cpu), за ним следовал Node в режиме Generator (10% cpu), Node в режиме обработки потребляли порядка 4% cpu, потребление оперативной памяти было на стабильном уровне (больше всех потреблял redis-server), утечек памяти выявлено не было.